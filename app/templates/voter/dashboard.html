{% extends "base.html" %}
{% block title %}Voter Dashboard | KuraSmart{% endblock %}
{% block content %}
{% include 'includes/ticker.html' %}
<div class="d-lg-none text-end p-3">
  <button class="btn btn-outline-warning" onclick="toggleSidebar()">
    <i class="bi bi-list fs-4"></i> Menu
  </button>
</div>
<style>
#sidebarTabs {
  word-wrap: break-word;
  max-width: 100%;
  padding: 1rem;
  background: #fcbf49;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
  position: relative;
  z-index: 1050;
}

/* Sidebar collapsible behavior on small screens */
@media (max-width: 992px) {
  #sidebarTabs {
    display: none;
    position:static;
    top: 60px;
    left: 0;
    width: 80%;
    padding: 1rem;
    background: #fcbf49;
    z-index: 1050;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.959);
  }
}

#sidebarTabs .list-group a {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  font-size: 1rem;
  text-decoration: none;
  border-radius: 1rem;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);

  color: #333;
  transition: background 0.2s;
}

/* On hover */
#sidebarTabs .list-group a:hover {
  background-color: #ffeaa7;
}

/* Icon + text container should flex and shrink properly */
#sidebarTabs .list-group span {
  flex: 1 1 auto;
  min-width: 0;
  font-size: 1rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Ensure small screen readability */
@media (max-width: 576px) {
  #sidebarTabs .list-group a {
    font-size: 0.875rem;
    padding-left: 0.75rem;
    padding-right: 0.75rem;
    gap: 0.4rem;
  }

  #sidebarTabs .list-group span {
    font-size: 0.85rem;
    white-space: normal;
    overflow-wrap: break-word;
  }
}

.profile-img {
  cursor: pointer;
}
@media (max-width: 575.98px) {
  #electionGrid > .col-md-6 {
    width: 70% !important;
    flex: 20 0 35% !important;
    max-width: 70% !important;
  }
}
.election-card.active-style {
  position: relative;
  width: 100%;
  height: 100%;
  background: transparent;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 2rem;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  backdrop-filter: blur(8px);
}

/* Rotating background layer */
.election-card.active-style::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: conic-gradient(
    from 0deg,
    #f9fc6d,
    #6fff2c,
    #fd2111,
    #4410d3
  );
  animation: rotBGimg 6s linear infinite;
  z-index: 0;
  filter: blur(40px);
}

/* Inner masked layer for depth */
.election-card.active-style::after {
  content: '';
  position: absolute;
  inset: 5px;
  background: rgba(250, 248, 248, 0.7);
  border-radius: 15px;
  z-index: 1;
  box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.05);
}

/* Rotating animation */
@keyframes rotBGimg {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* Content styling */
.election-card.active-style .card-body {
  position: relative;
  z-index: 2;
  color: #ffffff;
  text-align: center;
  font-family: 'Segoe UI', sans-serif;
  animation: fadeIn 1s ease-in-out;
}

.election-card.active-style .card-body h2 {
  font-size: 2.2rem;
  font-weight: 600;
  margin-bottom: 0.6rem;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
}

.election-card.active-style .card-body p {
  font-size: 1.05rem;
  font-weight: 400;
  opacity: 0.9;
  line-height: 1.5;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
/* From Uiverse.io by RodolpheANDRIEUX */ 
.cube-container {
  width: 200px;
  height: 200px;
  perspective: 800px;
  margin: 50px auto;
  transition: 0.8s ease-out;
}

.cube-container:hover {
  transform: scale(2);
}

.cube {
  position: relative;
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  animation: rotate 8s infinite linear;
}

.face {
  --french: linear-gradient(
      to right,
      #0000ff,
      #ffffff,
      #48fa07,
      #ffffff,
      #ff0000
    )
    1;
  position: absolute;
  width: 200px;
  height: 200px;
  color: white;
  font-size: 18px;
  text-align: center;
  line-height: 200px;
  background: #fcbf49;
  border: 2px solid;
  border-image: var(--french);
}

.front {
  transform: translateZ(100px);
}

.back {
  transform: rotateY(180deg) translateZ(100px);
}

.right {
  transform: rotateY(90deg) translateZ(100px);
}

.left {
  transform: rotateY(-90deg) translateZ(100px);
}

.top {
  transform: rotateX(90deg) translateZ(100px);
}

.bottom {
  transform: rotateX(-90deg) translateZ(100px);
}

@keyframes rotate {
  0% {
    transform: rotateX(0) rotateY(0) rotateZ(0);
  }

  100% {
    transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg);
  }
}

</style>

<div style="min-height: 100vh; background: conic-gradient(from 135deg, #fcbf49 0% 70%, #1e3a8a 70% 85%, #000000 85% 100%);">
      <div class="row">
        <div class="col-lg-3 mb-4" id="sidebarTabs">
            <div class="list-group">
                <a class="d-flex justify-content-between align-items-center rounded-4 shadow-sm px-4 py-3 mb-2 text-decoration-none"
                data-bs-toggle="collapse"
                href="#profileCollapse"
                role="button"
                aria-expanded="false"
                aria-controls="profileCollapse"
                data-aos="fade-up">

                <div class="d-flex align-items-center">
                    <i class="bi bi-person-circle text-secondary me-2"></i>
                    <span class="fw-semibold">Profile</span>
                </div>

                <i class="bi bi-chevron-right text-muted"></i>
                </a>

                <a href="#" class="d-flex justify-content-between align-items-center rounded-4 shadow-sm px-4 py-3 mb-2 text-decoration-none"
                  data-bs-toggle="offcanvas" data-bs-target="#votingHistoryOffcanvas" data-aos="fade-up">

                  
                  <span class="fw-semibold">
                      <i class="bi bi-clock-history text-primary me-2"></i> Voting History
                  </span>

                  <i class="bi bi-chevron-right text-muted"></i>
                </a>

                <div class="offcanvas offcanvas-end" tabindex="-1" id="votingHistoryOffcanvas" aria-labelledby="votingHistoryOffcanvasLabel">
                  <div class="offcanvas-header bg-primary text-white">
                    <h5 class="offcanvas-title" id="votingHistoryOffcanvasLabel">
                      <i class="bi bi-clock-history me-2"></i> My Voting History
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                  </div>
                  <div class="offcanvas-body bg-warning text-dark">
                    {% if votes %}
                    <div class="row">
                      {% for vote in votes %}
                      <div class="col-md-6 mb-4" data-aos="fade-up" data-aos-delay="{{ loop.index * 100 }}">
                        <div class="card shadow border-0 rounded-4">
                          <div class="card-header bg-primary text-white rounded-top-4">
                            <strong>{{ vote.election.title }}</strong>
                            <span class="float-end small">{{ vote.timestamp.strftime('%d %b %Y, %I:%M %p') }}</span>
                          </div>
                          <div class="card-body">
                            <p class="mb-1"><strong>Position:</strong> {{ vote.position.name }}</p>
                            <p class="mb-1"><strong>Candidate:</strong> {{ vote.candidate.full_name }}</p>
                            <p class="text-muted small mb-0">Voted on {{ vote.timestamp.strftime('%A, %d %B %Y at %I:%M %p') }}</p>
                          </div>
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                      <i class="bi bi-emoji-frown text-secondary fs-1"></i>
                      <p class="mt-3 text-muted fs-5">You haven‚Äôt participated in any elections yet.</p>
                    </div>
                    {% endif %}
                  </div>
                </div>


                <a href="{{ url_for('voter.user_notifications') }}"
                class="d-flex justify-content-between align-items-center rounded-4 shadow-sm px-4 py-3 mb-2 text-decoration-none"
                data-aos="fade-up">

                <div class="d-flex align-items-center">
                    <i class="fas fa-bell me-3" style="opacity: 0.5; color: #666666;"></i>
                    <span class="fw-semibold">Notifications</span>
                </div>

                {% if unread_count > 0 %}
                    <span class="badge bg-danger rounded-pill px-3 py-2">
                    {{ unread_count }}
                    </span>
                {% else %}
                    <i class="bi bi-chevron-right text-muted"></i>
                {% endif %}
                </a>



                <a href="{{ url_for('voter.help_support') }}#support"
                class="d-flex justify-content-between align-items-center rounded-4 shadow-sm px-4 py-3 mb-2 text-decoration-none"
                data-aos="fade-up">

                <div class="d-flex align-items-center">
                    <i class="bi bi-question-circle-fill text-info me-2"></i>
                    <span class="fw-semibold">Help & Support</span>
                </div>

                <i class="bi bi-chevron-right text-muted"></i>
                </a>

            </div>
            <div class="cube-container my-4">
            <div class="cube">
                <div class="face front"><i class="bi bi-calendar4-event"></i><span>KuraSmart</span></div>
                <div class="face back"><i class="bi bi-lightbulb-fill me-2"></i>Smart Democracy</div>
                <div class="face right"><i class="bi bi-check2-circle me-2"></i>Vote Wisely</div>
                <div class="face left"><i class="bi bi-megaphone-fill me-2"></i>Your Voice</div>
                <div class="face top"><i class="bi bi-shield-lock-fill me-2"></i>Secure</div>
                <div class="face bottom"><i class="bi bi-eye-fill me-2"></i>Transparent</div>
            </div>
        </div>
          </div>


        <!-- Main Content -->
        <div class="col-lg-9">
            <h2 class="mb-4 fw-bold">Welcome Voter, <span class="text-primary">{{ current_user.full_name }}</span></h2>

            <!-- Collapsible Profile -->
            <div class="collapse" id="profileCollapse">
                <div class="card shadow-sm border-0 rounded-4 mb-4">
                    <div class="card-header text-center py-4" style="background: linear-gradient(to right, #f3cd6b, #093bc5);">
                        <!-- Clickable Profile Image -->
                        <img src="{{ url_for('static', filename=current_user.profile_image if current_user.profile_image else 'profile_images/default-profile.png') }}"
                            alt="Profile Image"
                            class="rounded-circle shadow border border-3 profile-img"
                            style="width: 150px; height: 150px; object-fit: cover;"
                            data-bs-toggle="modal" data-bs-target="#uploadModal">

                        <h4 class="mt-3 mb-0 text-dark fw-bold">{{ current_user.full_name }}</h4>
                        <small class="text-muted">Click the image to update profile picture</small>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Email</p><p class="fw-medium text-dark">{{ current_user.email }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">National ID</p><p class="fw-medium text-dark">{{ current_user.national_id }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Voter Type</p><p class="fw-medium text-dark">{{ current_user.voting_type|capitalize }}</p></div>
                            <div class="col-sm-6">
                                <p class="mb-1 text-muted small">Status</p>
                                <p class="fw-bold {% if current_user.is_verified %}text-success{% else %}text-danger{% endif %}">
                                    {% if current_user.is_verified %}Verified{% else %}Not Verified{% endif %}
                                </p>
                            </div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Date of Birth</p><p class="fw-medium text-dark">{{ current_user.dob or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Gender</p><p class="fw-medium text-dark">{{ current_user.gender or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">County</p><p class="fw-medium text-dark">{{ current_user.county or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Sub-County</p><p class="fw-medium text-dark">{{ current_user.sub_county or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Division</p><p class="fw-medium text-dark">{{ current_user.division or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Location</p><p class="fw-medium text-dark">{{ current_user.location or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Sub-Location</p><p class="fw-medium text-dark">{{ current_user.sub_location or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Registered On</p><p class="fw-medium text-dark">{{ current_user.created_at.strftime('%Y-%m-%d') }}</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Election Search -->
                <form method="GET" class="mb-4">
                  <div class="input-group shadow-sm rounded-pill bg-white w-75">
                    <input 
                      type="text" 
                      name="search_title"
                      id="electionSearch"
                      class="form-control border-0 rounded-pill ps-4" 
                      placeholder="Search Elections‚Ä¶" 
                      value="{{ request.args.get('search_title', '') }}"
                      aria-label="Search Elections">
                    
                    <button type="submit" class="btn btn-outline-success rounded-circle" aria-label="Search">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                </form>




            <!-- Elections Header -->
            <div class="d-flex justify-content-center my-3">
                <h3 class="text-center px-4 py-2 rounded-pill" style="background-color: rgb(240, 188, 47); width: fit-content; color: #000;">
                    üó≥Ô∏è All Elections
                </h3>
            </div>

            <div class="row g-4" id="electionGrid">
            {% for election in all_elections %}
                {% set has_voted = election.id in voted_election_ids %}
                <div class="col-md-6 col-lg-4" data-aos="fade-up">
                <a href="{{ url_for('voter.view_election', election_id=election.id) }}" class="text-decoration-none">
                    
                    <div class="card h-100 shadow-sm border-0 rounded-4 overflow-hidden election-card
                    {% if election.current_status == 'pending' %} neon-border-animated 
                    {% elif election.current_status == 'active' %} active-style 
                    {% endif %}">
                    <div class="card-body">
                        <h5 class="card-title fw-semibold text-dark">
                        {{ election.title }}
                        </h5>
                        <p class="card-subtitle mb-2 text-muted small">
                        {% if election.current_status == 'active' %}
                            Ends: {{ election.end_date.strftime('%Y-%m-%d %H:%M') }}
                        {% elif election.current_status == 'pending' %}
                            Starts: {{ election.start_date.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                            Ended: {{ election.end_date.strftime('%Y-%m-%d %H:%M') }}
                        {% endif %}
                        </p>

                        <div class="mt-3 text-center">
                        {% if election.current_status == 'active' and user.is_verified and not has_voted %}
                            <span class="badge bg-success px-3 py-2">üó≥Ô∏è Ongoing ‚Äî Vote Now</span>
                        {% elif has_voted %}
                            <span class="badge bg-primary px-3 py-2">‚úÖ You Voted</span>
                        {% elif election.current_status == 'ended' %}
                            <span class="badge bg-danger px-3 py-2">Ended</span>
                        {% else %}
                            <span class="badge bg-secondary px-3 py-2">Pending</span>
                        {% endif %}
                        </div>

                    </div>
                    </div>

                </a>
                </div>
            {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Profile Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('voter.voter_dashboard') }}" enctype="multipart/form-data" class="modal-content">
      {{ form.hidden_tag() }}
      <div class="modal-header">
        <h5 class="modal-title" id="uploadModalLabel">Change Profile Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="image" class="form-label">Choose New Profile Picture</label>
          <input class="form-control" type="file" id="profileImage" name="image" accept="image/*" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Upload</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>


<script>
document.getElementById('electionSearch').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    document.querySelectorAll('#electionGrid .election-card').forEach(card => {
        const title = card.querySelector('.card-title').innerText.toLowerCase();
        card.closest('.col-md-6').style.display = title.includes(query) ? 'block' : 'none';
    });
});

function toggleSidebar() {
    const sidebar = document.getElementById('sidebarTabs');
    sidebar.style.display = (sidebar.style.display === 'none' || getComputedStyle(sidebar).display === 'none') ? 'block' : 'none';
}
</script>
{% endblock %}
