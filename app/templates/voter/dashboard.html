{% extends "base.html" %}
{% block title %}Voter Dashboard | KuraSmart{% endblock %}

{% block content %}
{% include 'includes/ticker.html' %}
<style>
@media (max-width: 992px) {
    #sidebarTabs {
        display: none;
    }
    .profile-img {
        cursor: pointer;
    }
}
.profile-img {
    cursor: pointer;
}
</style>

<div class="container-fluid">
    <!-- Toggle Sidebar Button -->
    <div class="text-end mb-3 d-lg-none">
        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSidebar()">‚ò∞ Toggle Sidebar</button>
    </div>

    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 mb-4" id="sidebarTabs">
            <div class="list-group">
                <a class="list-group-item list-group-item-action active" data-bs-toggle="collapse" href="#profileCollapse" role="button" aria-expanded="false" aria-controls="profileCollapse">
                    <i class="bi bi-person-circle me-2"></i> Profile
                </a>
                <a href="{{ url_for('admin_web.election_results') }}" class="list-group-item list-group-item-action">
                    <i class="bi bi-clock-history me-2"></i> Voting History
                </a>
                <a href="{{ url_for('voter.user_notifications') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <span><i class="bi bi-bell-fill me-2 text-warning"></i> Notifications</span>
                {% if unread_count > 0 %}
                    <span class="badge bg-danger rounded-pill">{{ unread_count }}</span>
                {% endif %}
                </a>


                <a href="{{ url_for('main.index') }}#support" class="list-group-item list-group-item-action">
                    <i class="bi bi-question-circle-fill me-2"></i> Help & Support
                </a>
            </div>
        </div>


        <!-- Main Content -->
        <div class="col-lg-9">
            <h2 class="mb-4 fw-bold">Welcome Voter, <span class="text-primary">{{ current_user.full_name }}</span></h2>

            <!-- Collapsible Profile -->
            <div class="collapse" id="profileCollapse">
                <div class="card shadow-sm border-0 rounded-4 mb-4">
                    <div class="card-header text-center py-4" style="background: linear-gradient(to right, #f3cd6b, #f0b64d);">
                        <!-- Clickable Profile Image -->
                        <img src="{{ url_for('static', filename=current_user.profile_image if current_user.profile_image else 'profile_images/default-profile.png') }}"
                            alt="Profile Image"
                            class="rounded-circle shadow border border-3 profile-img"
                            style="width: 150px; height: 150px; object-fit: cover;"
                            data-bs-toggle="modal" data-bs-target="#uploadModal">

                        <h4 class="mt-3 mb-0 text-dark fw-bold">{{ current_user.full_name }}</h4>
                        <small class="text-muted">Click the image to update profile picture</small>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Email</p><p class="fw-medium text-dark">{{ current_user.email }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">National ID</p><p class="fw-medium text-dark">{{ current_user.national_id }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Voter Type</p><p class="fw-medium text-dark">{{ current_user.voting_type|capitalize }}</p></div>
                            <div class="col-sm-6">
                                <p class="mb-1 text-muted small">Status</p>
                                <p class="fw-bold {% if current_user.is_verified %}text-success{% else %}text-danger{% endif %}">
                                    {% if current_user.is_verified %}Verified{% else %}Not Verified{% endif %}
                                </p>
                            </div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Date of Birth</p><p class="fw-medium text-dark">{{ current_user.dob or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Gender</p><p class="fw-medium text-dark">{{ current_user.gender or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">County</p><p class="fw-medium text-dark">{{ current_user.county or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Sub-County</p><p class="fw-medium text-dark">{{ current_user.sub_county or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Division</p><p class="fw-medium text-dark">{{ current_user.division or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Location</p><p class="fw-medium text-dark">{{ current_user.location or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Sub-Location</p><p class="fw-medium text-dark">{{ current_user.sub_location or 'N/A' }}</p></div>
                            <div class="col-sm-6"><p class="mb-1 text-muted small">Registered On</p><p class="fw-medium text-dark">{{ current_user.created_at.strftime('%Y-%m-%d') }}</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Election Search -->
            <input type="text" id="electionSearch" placeholder="Search elections..." class="form-control mb-4">

            <!-- Elections Header -->
            <div class="d-flex justify-content-center my-3">
                <h3 class="text-center px-4 py-2 rounded-pill" style="background-color: rgb(240, 188, 47); width: fit-content; color: #000;">
                    üó≥Ô∏è All Elections
                </h3>
            </div>

            <!-- Elections -->
            <div class="row g-4" id="electionGrid">
                {% for election in all_elections %}
                {% set has_voted = election.id in voted_election_ids %}
                <div class="col-md-6 col-lg-4">
                    <a href="{{ url_for('voter.view_election', election_id=election.id) }}" class="text-decoration-none text-dark">
                        <div class="election-card {{ election.current_status }} {% if election.current_status == 'active' %}neon-pulse{% endif %}">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <h4 class="card-title">{{ election.title }}</h4>
                                    <p class="card-subtitle text-muted">
                                        {% if election.current_status == 'active' %}
                                            Ends: {{ election.end_date.strftime('%Y-%m-%d %H:%M') }}
                                        {% elif election.current_status == 'pending' %}
                                            Starts: {{ election.start_date.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                            Ended: {{ election.end_date.strftime('%Y-%m-%d %H:%M') }}
                                        {% endif %}
                                    </p>
                                    <div class="mt-3 text-center">
                                        {% if election.current_status == 'active' and user.is_verified and not has_voted %}
                                            <span class="badge bg-success">Ongoing ‚Äî Vote Now</span>
                                        {% elif has_voted %}
                                            <span class="badge bg-primary">‚úÖ You Voted</span>
                                        {% elif election.current_status == 'ended' %}
                                            <span class="badge bg-danger">Ended</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Pending</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
                <a href="{{ request.referrer or url_for('dashboard.dashboard_home') }}" class="btn btn-outline-secondary mb-4">‚Üê Back</a>
            </div>
        </div>
    </div>
</div>

<!-- Profile Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('voter.voter_dashboard') }}" enctype="multipart/form-data" class="modal-content">
      {{ form.hidden_tag() }}
      <div class="modal-header">
        <h5 class="modal-title" id="uploadModalLabel">Change Profile Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="image" class="form-label">Choose New Profile Picture</label>
          <input class="form-control" type="file" id="profileImage" name="image" accept="image/*" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Upload</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>


<script>
document.getElementById('electionSearch').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    document.querySelectorAll('#electionGrid .election-card').forEach(card => {
        const title = card.querySelector('.card-title').innerText.toLowerCase();
        card.closest('.col-md-6').style.display = title.includes(query) ? 'block' : 'none';
    });
});

function toggleSidebar() {
    const sidebar = document.getElementById('sidebarTabs');
    sidebar.style.display = (sidebar.style.display === 'none' || getComputedStyle(sidebar).display === 'none') ? 'block' : 'none';
}
</script>

<style>
.election-card {
  background-color: #f5f5f5;
  border-radius: 22px;
  padding: 0.8rem;
  font-family: 'Open Sans', sans-serif;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  height: 100%;
  position: relative;
}
.election-card:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.active.neon-pulse {
  background: #000;
  color: #fff;
  border: 2px solid #0ff;
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
}
.active.neon-pulse::before,
.active.neon-pulse::after {
  content: "";
  position: absolute;
  inset: -4px;
  border: 2px solid #0ff;
  border-radius: inherit;
  animation: pulseOut 2s ease-out infinite;
  opacity: 0;
  pointer-events: none;
}
.active.neon-pulse::after {
  animation-delay: 1s;
}
@keyframes pulseOut {
  0% { transform: scale(1); opacity: 1; }
  100% { transform: scale(1.5); opacity: 0; }
}
.pending {
  background-color: #eaeaea;
  opacity: 0.85;
  border: 1px solid #ccc;
}
.ended {
  background-color: #ee0404;
  filter: grayscale(70%);
  position: relative;
}
.ended::after {
  content: 'ENDED';
  position: absolute;
  top: 10px;
  right: 10px;
  background-color: #cc0000;
  color: hsl(40, 13%, 95%);
  padding: 4px 8px;
  font-size: 0.75rem;
  font-weight: bold;
  border-radius: 4px;
}
@media (max-width: 768px) {
  .list-group-item {
    font-size: 0.9rem;
    padding: 0.6rem 1rem;
  }
}
</style>
{% endblock %}
