{% extends "base.html" %}

{% block title %}My Election Results | KuraSmart{% endblock %}

{% block content %}
<div class="py-5 min-vh-100" style="background: linear-gradient(170deg, rgba(58, 56, 56, 0.623) 0%, rgb(235, 207, 53) 100%);">
  <div class="container-fluid px-3 px-sm-4 px-md-5" data-aos="fade-up">

    <h2 class="text-center fw-bold mb-5">
      <i class="bi bi-bar-chart-line text-warning me-2"></i> My Election Results
    </h2>

    {% if results %}
      {% for position, pos_results in results.items() %}
        <!-- Use flex container for cards -->
        <div class="d-flex flex-wrap justify-content-center gap-4">
          {% for result in pos_results %}
            <div data-aos="fade-up" data-aos-delay="{{ loop.index * 100 }}">
              <div class="card_box">
                <span></span>
                <div class="p-3 text-white d-flex flex-column justify-content-between h-100" style="height: 250px; width: 200px;">
                  <div>
                    <h5 class="mb-2 text-truncate" title="{{ result.election.title }}">
                      {{ result.election.title }}
                    </h5>
                    <small class="d-block mb-3 text-white-50">
                      {{ result.timestamp.strftime('%d %b %Y') if result.timestamp else '' }}
                    </small>
                    <p><strong>Winner:</strong> 
                      {{ result.winner.candidate.full_name if result.winner and result.winner.candidate else 'N/A' }}
                    </p>
                  </div>
                  <button class="btn btn-outline-light btn-sm rounded-pill align-self-start"
                          data-bs-toggle="offcanvas"
                          data-bs-target="#offcanvas{{ position|replace(' ', '_') }}{{ loop.index }}">
                    View Details
                  </button>
                </div>
              </div>
            </div>

            <!-- Offcanvas -->
            <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvas{{ position|replace(' ', '_') }}{{ loop.index }}" aria-labelledby="offcanvasLabel{{ position|replace(' ', '_') }}{{ loop.index }}">
              <div class="offcanvas-header">
                <h5 class="offcanvas-title text-truncate" id="offcanvasLabel{{ position|replace(' ', '_') }}{{ loop.index }}">
                  {{ result.election.title }} - Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
              </div>
              <div class="offcanvas-body">
                <p><strong>Election:</strong> {{ result.election.title }}</p>
                <p><strong>Date:</strong> {{ result.timestamp.strftime('%A, %d %B %Y') if result.timestamp else 'N/A' }}</p>
                <hr>

                <h6>Candidates grouped by Position</h6>

                {% set candidates_by_position = {} %}
                {% for cand in result.candidates %}
                  {% set pos_name = cand.candidate.position.name if cand.candidate.position else 'Other' %}
                  {% if pos_name not in candidates_by_position %}
                    {% set _ = candidates_by_position.update({pos_name: []}) %}
                  {% endif %}
                  {% set _ = candidates_by_position[pos_name].append(cand) %}
                {% endfor %}

                {% for pos_name, candidates_list in candidates_by_position.items() %}
                  <h6 class="mt-3">{{ pos_name }}</h6>
                  <ul class="list-group mb-3">
                    {% for cand in candidates_list|sort(attribute='votes', reverse=True) %}
                      <li class="list-group-item d-flex justify-content-between align-items-center
                        {% if loop.index == 1 %}list-group-item-success fw-bold
                        {% elif loop.index == 2 %}list-group-item-info
                        {% elif loop.index == 3 %}list-group-item-warning
                        {% endif %}">
                        {{ loop.index }}. {{ cand.candidate.full_name }}
                        <span class="badge bg-primary rounded-pill">{{ cand.votes }}</span>
                      </li>
                    {% endfor %}
                  </ul>
                {% endfor %}
              </div>
            </div>

          {% endfor %}
        </div>
      {% endfor %}
    {% else %}
      <p class="text-center text-muted">No results found.</p>
    {% endif %}

    <div class="text-center mt-5">
      <a href="{{ request.referrer or url_for('voter.voter_dashboard') }}" class="btn btn-outline-secondary rounded-pill px-4">
        ‚Üê Back to Dashboard
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block head_extra %}
<style>
  /* From Uiverse.io by mrhyddenn */
  .container-fluid {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  .d-flex.flex-wrap.justify-content-center.gap-4 {
    gap: 1.5rem !important;
  }

  .card_box {
    width: 200px;
    height: 250px;
    border-radius: 20px;
    background: linear-gradient(170deg, rgb(2, 2, 2) 0%, rgb(248, 218, 49) 100%);
    position: relative;
    box-shadow: 0 25px 50px rgb(250, 21, 5);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
  }

  .card_box:hover {
    transform: scale(0.9);
  }


  /* Text truncate */
  .text-truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Offcanvas scroll */
  .offcanvas-body {
    overflow-y: auto;
    padding-bottom: 1rem;
  }

  /* Ranking highlight colors */
  .list-group-item-success {
    background-color: #fcbf49 !important;
  }

  .list-group-item-info {
    background-color: #76cde0 !important;
  }

  .list-group-item-warning {
    background-color: #fff8d6 !important;
  }

  /* Responsive for small devices */
  @media (max-width: 575.98px) {
    .card_box {
      width: 100%;
      height: auto;
    }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  AOS.init({
    duration: 700,
    once: true,
    easing: 'ease-in-out'
  });
</script>
{% endblock %}
